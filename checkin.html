// ‡∏£‡∏∞‡∏ö‡∏∏ ID ‡∏Ç‡∏≠‡∏á Google Spreadsheet ‡πÅ‡∏•‡∏∞ Google Drive Folder ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
var SPREADSHEET_ID = '11hXJWlWcs_rBzhbos0nxs4vyNsZ6KSUInatqpWRdcgk ';
var FOLDER_ID = '1bbSvu3om2UBN-S7tfEiQvKcFdSDnybpi '; // ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
var SHEET_NAME = 'DATA ';
var LINE_NOTIFY_TOKEN = 'xjMIkKMfhdoVz48dUhWhLGyn490iIOUmEzIuRwW16mDwkHXU+blarDp5Gad2wh/zGlwrwcNEsqnWyGNRmBEnuAxkHn8XRAquXlHEoPCu1QJg5y5QbpodBGy+++X5leBLrrmQ+Xw6xMEQInhQo2QvtQdB04t89/1O/w1cDnyilFU= ';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏ú‡πà‡∏≤‡∏ô LINE Notify
function sendLineNotifyMessage(message, imageUrl) {
  var url = 'https://notify-api.line.me/api/notify';
  var headers = {
    'Authorization': 'Bearer ' + LINE_NOTIFY_TOKEN,
  };
  var payload = { 'message': message };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏Å‡∏°‡∏µ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  if (imageUrl) {
    payload['imageThumbnail'] = imageUrl;
    payload['imageFullsize'] = imageUrl;
  }

  var options = {
    'method': 'post',
    'headers': headers,
    'payload': payload,
  };

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Notify
  UrlFetchApp.fetch(url, options);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û Google Maps
function generateGoogleMapsImageLink(lat, long) {
  var fileId = generateStaticMapImageFileId(lat, long);
  var imageUrl = 'https://lh5.googleusercontent.com/d/' + fileId;
  return imageUrl;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏™‡πÅ‡∏ï‡∏ï‡∏¥‡∏Å
function generateStaticMapImageFileId(lat, long) {
  var map = Maps.newStaticMap()
    .setSize(400, 400)
    .setZoom(15)
    .addMarker(lat, long)
    .setFormat(Maps.StaticMap.Format.PNG)
    .setLanguage('en');

  var mapBlob = map.getBlob();
  var folder = DriveApp.getFolderById(FOLDER_ID); // ‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  var imageName = 'map_image_' + Utilities.formatDate(new Date(), 'GMT+7', 'dd-MM-yyyy_HH:mm:ss') + '.png';
  var file = folder.createFile(mapBlob);
  file.setName(imageName);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  
  // ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö ID ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
  return file.getId();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• base64 ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
function generateFileUrl(data, folderId) {
  var imageName = data.name + '_' + Utilities.formatDate(new Date(), 'GMT+7', 'dd-MM-yyyy_HH:mm:ss') + '.png';
  var decodedImage = Utilities.base64Decode(data.base64);
  var blob = Utilities.newBlob(decodedImage, 'image/png', imageName);
  var folder = DriveApp.getFolderById(folderId); // ‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û
  var file = folder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  
  // ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
  return 'https://lh5.googleusercontent.com/d/' + file.getId();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠ POST
function doPost(e) {
  try {
    var obj = JSON.parse(e.postData.contents);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°
    if (obj.action === "fetchData") {
      var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
      var data = sheet.getDataRange().getValues();
      return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
    }

    var fileUrl = generateFileUrl(obj, FOLDER_ID); // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÑ‡∏ü‡∏•‡πå
    var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);

    if (!sheet) {
      sheet = SpreadsheetApp.openById(SPREADSHEET_ID).insertSheet(SHEET_NAME);
      sheet.appendRow(['Timestamp', 'Image URL', 'name', 'role', 'job', 'note', 'formattedDate', 'time', 'address', 'lat', 'long', 'user', 'status', 'minutes']);
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô Google Sheet
    sheet.appendRow([
      Utilities.formatDate(new Date(), 'GMT+7', 'dd-MM-yyyy HH:mm:ss'),
      fileUrl,
      obj.name,
      obj.role,
      obj.job,
      obj.note,
      Utilities.formatDate(new Date(), 'GMT+7', 'dd/MM/yyyy'), // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      obj.time,
      obj.address,
      obj.lat,
      obj.long,
      obj.user,
    ]);

    var mapsImageLink = generateGoogleMapsImageLink(obj.lat, obj.long);
    var formattedDate = Utilities.formatDate(new Date(), 'GMT+7', 'dd/MM/yyyy'); // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    var basicMessage = `\n‚è∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤: ${obj.job}\nüë§ ‡∏ä‡∏∑‡πà‡∏≠: ${obj.name}\nüíº ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${obj.role}\nüìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${obj.note}\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formattedDate}\nüïí ‡πÄ‡∏ß‡∏•‡∏≤: ${obj.time}\nüè† ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${obj.address}`;
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE Notify ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û
    sendLineNotifyMessage(basicMessage, mapsImageLink);
    
    return ContentService.createTextOutput('Success').setMimeType(ContentService.MimeType.TEXT);
  } catch (error) {
    console.error(error);
    return ContentService.createTextOutput('Error: ' + error.message).setMimeType(ContentService.MimeType.TEXT);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠ GET
function doGet(e) {
  var data = fetchDataFromSheet();
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï
function fetchDataFromSheet() {
  var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  return sheet.getDataRange().getValues();
}
