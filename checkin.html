<!DOCTYPE html>
<html lang="th" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô ¬∑ Minimal</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

    <style>
      /* ===== Minimal black & white skin ===== */
      body { font-feature-settings: 'cv02','cv03','cv04','cv11'; }

      /* Subtle card hover (no scale) */
      .hover-ring:hover { box-shadow: 0 0 0 6px rgba(0,0,0,.04) inset; }

      /* Loading overlay */
      #loadingOverlay { display:none; position:absolute; inset:0; background:rgba(255,255,255,.85); z-index:40; }

      /* Segmented control: checked state */
      input[type="radio"]:checked + label {
        background: #000; color:#fff; border-color:#000;
      }

      /* Gentle blink for the location confirm button */
      @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.55} }
      .blink { animation: blink 1s infinite; }

      /* ===== üì∏ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ===== */
      /* 1. ‡∏û‡∏•‡∏¥‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å */
      #camera-preview {
        transform: scaleX(-1);
      }
      /* 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå "‡∏™‡∏ß‡∏¢" ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß */
      #preview {
        filter: brightness(1.05) contrast(1.1) saturate(1.1);
      }
      /* ===== ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ===== */
    </style>
  </head>

<body class="h-full bg-neutral-100 text-neutral-900 antialiased">
  <main class="min-h-screen flex items-center justify-center p-4">
    <div class="relative max-w-md w-full bg-white border border-neutral-200 rounded-2xl shadow-sm hover-ring">
      <header class="p-6 border-b border-neutral-200 space-y-3">
        <p class="text-sm font-bold text-red-600">
          üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå ‡∏≠‡∏¥‡∏ô‡πÇ‡∏ô‡πÄ‡∏ß‡∏ä‡∏±‡πà‡∏ô ‡∏à‡∏≥‡∏Å‡∏±‡∏î (‡∏õ‡πâ‡∏≤‡∏¢‡∏ã‡∏¥‡πà‡∏á)
        </p>
        <p class="text-sm text-black">
          ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ó‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ
        </p>
        <p class="text-sm text-blue-600">
          üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà 26 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568 ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ 1 ‡∏ß‡∏±‡∏ô
        </p>
        <p class="text-sm text-red-600">
          üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà 28 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568 ‚Üí ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        </p>
        <p class="text-sm text-black">
          ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢<br>
          ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏∏‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠ üôè
        </p>
      </header>
    </div>
  </main>
</body>


        <section class="px-6 pt-6">
          <div class="rounded-xl bg-black text-white p-5">
            <div id="date" class="text-xs tracking-wide opacity-80"></div>
            <div id="time" class="mt-1 text-5xl font-semibold leading-none"></div>
            <input type="date" id="todayInput" name="todayInput" class="hidden" />
            <input type="time" id="currentTime" name="currentTime" class="hidden" />
          </div>
        </section>

        <form id="data-form" class="p-6" onsubmit="return false;">
          <section id="step1">
            <div class="relative bg-neutral-50 p-4 rounded-xl border border-neutral-200">
              <div id="loadingOverlay" class="flex items-center justify-center">
                <span class="text-sm text-neutral-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Ä¶</span>
              </div>

              <div class="grid gap-2">
                <input id="columnBData" name="columnBData" type="text" required placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="input-field w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm placeholder-neutral-400 focus:outline-none focus:ring-1 focus:ring-black focus:border-black" />
                <input id="columnCData" name="columnCData" type="text" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="input-field w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm placeholder-neutral-400 focus:outline-none focus:ring-1 focus:ring-black focus:border-black" />
                <input id="columnDData" name="columnDData" type="text" required placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" class="input-field w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm placeholder-neutral-400 focus:outline-none focus:ring-1 focus:ring-black focus:border-black" />
                <input id="userId" name="userId" type="hidden" />
                <input id="columnAData" name="columnAData" type="hidden" />
                <input id="columnEData" name="columnEData" type="hidden" />
                <input id="columnFData" name="columnFData" type="hidden" />
                <input id="columnQData" name="columnQData" type="hidden" />
              </div>
            </div>

            <div class="mt-6">
              <div class="grid grid-cols-3 gap-2" role="group" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô">
                <div>
                  <input class="peer hidden" type="radio" id="radio-three" name="switch-job" value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô" />
                  <label for="radio-three" class="block w-full text-center select-none rounded-lg border border-neutral-300 px-3 py-2 text-sm font-medium cursor-pointer hover:bg-neutral-50">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
                </div>
                <div>
                  <input class="peer hidden" type="radio" id="radio-four" name="switch-job" value="‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢" />
                  <label for="radio-four" class="block w-full text-center select-none rounded-lg border border-neutral-300 px-3 py-2 text-sm font-medium cursor-pointer hover:bg-neutral-50">‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢</label>
                </div>
                <div>
                  <input class="peer hidden" type="radio" id="radio-five" name="switch-job" value="‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô" />
                  <label for="radio-five" class="block w-full text-center select-none rounded-lg border border-neutral-300 px-3 py-2 text-sm font-medium cursor-pointer hover:bg-neutral-50">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</label>
                </div>
              </div>
              <input type="hidden" id="jobInput" name="jobInput" required />
            </div>

            <div class="mt-4">
              <label for="noteInput" class="block text-sm font-medium text-neutral-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <textarea id="noteInput" name="noteInput" rows="3" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‚Ä¶" class="input-field w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm placeholder-neutral-400 focus:outline-none focus:ring-1 focus:ring-black focus:border-black"></textarea>
            </div>

            <div class="mt-6">
              <button type="button" onclick="nextStep()" class="w-full rounded-lg bg-black text-white px-4 py-3 text-sm font-semibold tracking-wide hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-black">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
          </section>

          <section id="step2" class="hidden">
            <div class="mt-2">
              <video id="camera-preview" class="w-full rounded-xl border border-neutral-200" autoplay playsinline poster="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/330px-No-Image-Placeholder.svg.png"></video>
              <img id="preview" class="w-full rounded-xl border border-neutral-200 mt-3" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û" />
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
              <button type="button" id="start-camera-btn" class="rounded-lg bg-white border border-neutral-300 px-4 py-3 text-sm font-medium hover:bg-neutral-50">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
              <button type="button" id="capture-btn" disabled class="rounded-lg bg-black text-white px-4 py-3 text-sm font-semibold tracking-wide disabled:opacity-50">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
            </div>

            <div class="flex gap-3 mt-6">
              <button type="button" onclick="prevStep()" class="w-1/3 rounded-lg bg-white border border-neutral-300 px-4 py-3 text-sm font-medium hover:bg-neutral-50">‡∏Å‡∏•‡∏±‡∏ö</button>
              <button type="button" onclick="checkPictureAndNextStep()" class="flex-1 rounded-lg bg-black text-white px-4 py-3 text-sm font-semibold tracking-wide hover:bg-neutral-800">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
          </section>

          <section id="step3" class="hidden">
            <div class="mt-2 rounded-xl border border-neutral-200 overflow-hidden">
              <button type="button" onclick="getLocation()" class="w-full bg-black text-white px-4 py-3 text-sm font-semibold tracking-wide blink">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</button>
              <div id="locationInfo" class="p-4 bg-neutral-50">
                <div class="flex items-center justify-between text-sm">
                  <p id="latitude" class="font-medium">Latitude:</p>
                  <p id="longitude" class="font-medium">Longitude:</p>
                </div>
                <p id="fullAddress" class="mt-2 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
              </div>
              <iframe id="mapIframe" class="w-full h-56 border-t border-neutral-200" frameborder="0" allowfullscreen></iframe>
            </div>

            <input type="hidden" id="latitudeInput" name="latitudeInput" />
            <input type="hidden" id="longitudeInput" name="longitudeInput" />
            <input type="hidden" id="fullAddressInput" name="fullAddressInput" required />

            <div class="flex gap-3 mt-6 mb-2">
              <button type="button" onclick="prevStep()" class="w-1/3 rounded-lg bg-white border border-neutral-300 px-4 py-3 text-sm font-medium hover:bg-neutral-50">‡∏Å‡∏•‡∏±‡∏ö</button>
              <button type="button" id="submitButton" onclick="submitForm()" class="flex-1 rounded-lg bg-black text-white px-4 py-3 text-sm font-semibold tracking-wide hover:bg-neutral-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
          </section>
        </form>
      </div>
    </main>

    <script>
      // ===== Config =====
      const WEB_APP_MEMBER_URL = 'https://script.google.com/macros/s/AKfycbxDpxZqliJAcwF5YXZeApOdoWj1OXtDFa54iMAECKaNQf1mXwPRE_yhi8G1Rj-nxLV2VA/exec';
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxOPOTCdmfclGOzIoHO4bYdecpfe45j-VLNqhofaC2W6HozgtG3rEICaWKp7lOlSu9wdQ/exec';
      const LIFF_ID = '2006738214-Q2Yrq7M7';

      // ===== Lifecycle =====
      window.onload = async () => { await initializeLiff(); };

      async function initializeLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (liff.isLoggedIn()) {
            getUserProfile();
          } else { liff.login(); }
        } catch (e) { console.error('Error initializing LIFF:', e); }
      }

      async function getUserProfile() {
        try {
          const profile = await liff.getProfile();
          document.getElementById('userId').value = profile.userId;
          document.getElementById('displayName').value = profile.displayName;
          await fetchData(profile.userId);
        } catch (e) { console.error('Error getting profile data:', e); }
      }

      async function fetchData(userId) {
        showLoading(true);
        try {
          const response = await fetch(WEB_APP_MEMBER_URL, { method:'POST', body: JSON.stringify({ action:'fetchData', userId }) });
          const data = await response.json();
          const userRows = data.filter(row => row[1] === userId);
          if (userRows.length > 0) {
            userRows.sort((a,b) => new Date(b[6]) - new Date(a[6]));
            displayData(userRows[0]);
          }
        } catch (e) { console.error('Error fetching data:', e); }
        finally { showLoading(false); }
      }

      function displayData(row) {
        document.getElementById('columnAData').value = row[1] || '';
        document.getElementById('columnBData').value = row[2] || '';
        document.getElementById('columnCData').value = row[3] || '';
        document.getElementById('columnDData').value = row[4] || '';
        document.getElementById('columnEData').value = row[5] || '';
        document.getElementById('columnFData').value = row[6] || '';
        document.getElementById('columnQData').value = row[17] || '';
      }

      function showLoading(isLoading) {
        const overlay = document.getElementById('loadingOverlay');
        const inputs = document.querySelectorAll('.input-field');
        overlay.style.display = isLoading ? 'flex' : 'none';
        inputs.forEach(i => i.disabled = isLoading);
      }

      // ===== Camera =====
      document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('camera-preview');
        const startBtn = document.getElementById('start-camera-btn');
        const captureBtn = document.getElementById('capture-btn');
        const previewImage = document.getElementById('preview');
        let stream;

        startBtn.addEventListener('click', async () => {
          try {
            // ‡πÉ‡∏ä‡πâ facingMode: "user" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream; captureBtn.disabled = false; video.style.display = 'block';
          } catch (err) { console.error('Error accessing the camera:', err); }
        });

        captureBtn.addEventListener('click', () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;

          // ===== üì∏ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç =====
          // ‡∏û‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (un-mirror) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö preview
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
          // ===== ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç =====
          
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          previewImage.src = canvas.toDataURL('image/png');
          video.style.display = 'none';
          if (stream) stream.getTracks().forEach(t => t.stop());
        });
      });

      function checkPictureAndNextStep() {
        const src = document.getElementById('preview').src || '';
        if (!src || src.includes('No-Image-Placeholder')) {
          Swal.fire({ title:'‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', icon:'warning', confirmButtonText:'OK' });
        } else { nextStep(); }
      }

      // ===== Submit =====
      const columnBData = document.getElementById('columnBData');
      const columnCData = document.getElementById('columnCData');
      const jobInput = document.getElementById('jobInput');
      const noteInput = document.getElementById('noteInput');
      const todayInput = document.getElementById('todayInput');
      const currentTime = document.getElementById('currentTime');
      const latitudeInput = document.getElementById('latitudeInput');
      const longitudeInput = document.getElementById('longitudeInput');
      const fullAddressInput = document.getElementById('fullAddressInput');
      const userId = document.getElementById('userId');
      const previewImg = document.getElementById('preview');

      function submitForm() {
        if (!columnBData.value || !columnCData.value || !jobInput.value || !latitudeInput.value || !longitudeInput.value) {
          Swal.fire({ title:'‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', icon:'warning', confirmButtonText:'OK' });
          return;
        }

        Swal.fire({
          title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text:'‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', icon:'question', showCancelButton:true, confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((res) => {
          if (res.isConfirmed) {
            document.getElementById('submitButton').disabled = true;
            Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‚Ä¶', showConfirmButton:false, allowOutsideClick:false, didOpen:() => Swal.showLoading() });

            const spt = (previewImg.src || '').split('base64,')[1];
            const payload = {
              base64: spt,
              name: columnBData.value,
              role: columnCData.value,
              job: jobInput.value,
              note: noteInput.value,
              today: todayInput.value,
              time: currentTime.value,
              lat: latitudeInput.value,
              long: longitudeInput.value,
              address: fullAddressInput.value,
              user: userId.value,
            };

            fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify(payload) })
              .then(r => r.text())
              .then(() => {
                Swal.close();
                Swal.fire({ title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', icon:'success', confirmButtonText:'‡∏õ‡∏¥‡∏î' })
                  .then(() => { sendFlexMessage(); });
              })
              .catch(err => {
                Swal.close();
                Swal.fire({ title:'Error!', text:'Form submission failed. Please try again.', icon:'error', confirmButtonText:'OK' })
                  .then(() => { document.getElementById('submitButton').disabled = false; });
                console.error(err);
              });
          }
        });
      }

      // ===== Flex message =====
      async function sendFlexMessage() {
        let jobColor = '#000000FF';
        let lateMessage = '';
        const checkInTime = '08:30';
        const checkAfternoonTime = '13:30';
        const checkOutTime = '17:30';
        const currentTimeValue = currentTime.value;

        if (jobInput.value === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô') {
          jobColor = '#16a34a';
          if (isLate(currentTimeValue, checkInTime)) {
            const d = getLateDetails(currentTimeValue, checkInTime);
            lateMessage = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏¢ ${d.hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${d.minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
          }
        } else if (jobInput.value === '‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢') {
          jobColor = '#ef4444';
          if (isLate(currentTimeValue, checkAfternoonTime)) {
            const d = getLateDetails(currentTimeValue, checkAfternoonTime);
            lateMessage = `‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢‡∏™‡∏≤‡∏¢ ${d.hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${d.minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
          }
        } else if (jobInput.value === '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô') {
          jobColor = '#111827';
          if (isLate(currentTimeValue, checkOutTime)) {
            const d = getLateDetails(currentTimeValue, checkOutTime);
            lateMessage = `‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${d.hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${d.minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
          }
        }

        const flexMessage = {
          type: 'flex',
          altText: '‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô',
          contents: {
            type: 'bubble',
            direction: 'ltr',
            body: {
              type: 'box',
              layout: 'vertical',
              spacing: 'md',
              contents: [
                { type:'box', layout:'horizontal', contents:[
                    { type:'text', text:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô', weight:'bold', size:'md', align:'start', margin:'sm' },
                    { type:'text', text:` ${jobInput.value}`, weight:'bold', size:'md', color: jobColor, align:'end' },
                  ] },
                { type:'separator' },
                { type:'box', layout:'vertical', spacing:'sm', contents:[
                    { type:'box', layout:'baseline', contents:[
                        { type:'text', text:'‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', weight:'bold', size:'sm', margin:'sm' },
                        { type:'text', text:`${columnBData.value}`, size:'sm', color:'#000000FF', align:'end' } ] },
                    { type:'box', layout:'baseline', contents:[
                        { type:'text', text:'‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', weight:'bold', size:'sm', flex:0, margin:'sm' },
                        { type:'text', text:`${columnCData.value}`, size:'sm', color:'#000000FF', align:'end' } ] },
                  ] },
                { type:'separator' },
                { type:'box', layout:'vertical', contents:[
                    { type:'box', layout:'baseline', contents:[
                        { type:'text', text:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', weight:'bold' },
                        { type:'text', text:`${formatDateDisplay(todayInput.value)}`, weight:'bold', align:'end' } ] },
                    { type:'box', layout:'baseline', contents:[
                        { type:'text', text:'‡πÄ‡∏ß‡∏•‡∏≤', weight:'bold' },
                        { type:'text', text:`${currentTime.value}`, weight:'bold', size:'xl', color: jobColor, align:'end' } ] },
                  ] },
                { type:'separator' },
                { type:'box', layout:'vertical', spacing:'xs', margin:'sm', contents:[
                    { type:'text', text:'‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', weight:'bold', size:'sm', margin:'md' },
                    { type:'text', text: fullAddressInput.value ? `${fullAddressInput.value}` : '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', wrap:true },
                  ] },
                ...(lateMessage ? [{ type:'separator' }, { type:'box', layout:'vertical', spacing:'xs', margin:'sm', contents:[ { type:'text', text: lateMessage, weight:'bold', size:'sm', margin:'md', color: (jobInput.value === '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô') ? '#16a34a' : '#ef4444' } ] }] : [])
              ]
            }
          }
        };

        await liff.sendMessages([flexMessage]);
        liff.closeWindow();
      }

      function isLate(currentTime, standardTime) {
        const [ch, cm] = currentTime.split(':').map(Number);
        const [sh, sm] = standardTime.split(':').map(Number);
        return (ch > sh) || (ch === sh && cm > sm);
      }
      function getLateDetails(currentTime, standardTime) {
        const [ch, cm] = currentTime.split(':').map(Number);
        const [sh, sm] = standardTime.split(':').map(Number);
        const cur = ch*60 + cm, sta = sh*60 + sm; const diff = cur - sta; return { hours: Math.floor(diff/60), minutes: diff % 60 };
      }
      function formatDateDisplay(value) {
        const d = new Date(value); const dd = String(d.getDate()).padStart(2,'0'); const mm = String(d.getMonth()+1).padStart(2,'0'); const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      // ===== Date & time (Bangkok) =====
      function updateDateTime() {
        const dateEl = document.getElementById('date');
        const timeEl = document.getElementById('time');
        const now = new Date();
        const formattedDate = now.toLocaleDateString('th-TH', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        const formattedTime = now.toLocaleTimeString('en-US', { hour:'numeric', minute:'numeric', second:'numeric', hour12:false, timeZone:'Asia/Bangkok' });
        dateEl.textContent = formattedDate; timeEl.textContent = formattedTime;
      }
      setInterval(updateDateTime, 1000); updateDateTime();

      // Initialize hidden inputs for date/time (Bangkok)
      function getCurrentTimeInBangkok() {
        const now = new Date();
        const bkk = new Date(now.toLocaleString('en-US', { timeZone:'Asia/Bangkok' }));
        const hh = String(bkk.getHours()).padStart(2,'0'); const mm = String(bkk.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      }
      document.getElementById('currentTime').value = getCurrentTimeInBangkok();
      function getFormattedDateHidden() {
        const t = new Date(); const y = t.getFullYear(); const m = String(t.getMonth()+1).padStart(2,'0'); const d = String(t.getDate()).padStart(2,'0');
        return `${y}-${m}-${d}`; // keep as yyyy-mm-dd for <input type="date">
      }
      document.getElementById('todayInput').value = getFormattedDateHidden();

      // ===== Job segmented control sync =====
      document.querySelectorAll('input[name="switch-job"]').forEach(r => {
        r.addEventListener('change', function() {
          document.getElementById('jobInput').value = this.value;
        });
      });

      // ===== Geolocation =====
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(displayLocation);
        } else { alert('Geolocation is not supported by this browser.'); }
      }
      function displayLocation(position) {
        const lat = position.coords.latitude; const lon = position.coords.longitude;
        document.getElementById('latitude').innerText = `Latitude: ${lat}`;
        document.getElementById('longitude').innerText = `Longitude: ${lon}`;
        document.getElementById('latitudeInput').value = lat; document.getElementById('longitudeInput').value = lon;

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
          .then(r => r.json())
          .then(data => {
            if (data.display_name) {
              const fullAddress = data.display_name;
              document.getElementById('fullAddress').innerText = `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${fullAddress}`;
              document.getElementById('fullAddressInput').value = fullAddress;
            } else { document.getElementById('fullAddress').innerText = 'Unable to retrieve full address.'; }
          })
          .catch(() => { document.getElementById('fullAddress').innerText = 'Error fetching reverse geocoding data.'; });

        document.getElementById('mapIframe').src = `https://www.google.com/maps?q=${lat},${lon}&output=embed`;
      }

      // ===== Stepper =====
      let currentStep = 1;
      function nextStep() {
        if (currentStep < 3) {
          document.getElementById(`step${currentStep}`).classList.add('hidden');
          currentStep++; document.getElementById(`step${currentStep}`).classList.remove('hidden');
        }
      }
      function prevStep() {
        if (currentStep > 1) {
          document.getElementById(`step${currentStep}`).classList.add('hidden');
          currentStep--; document.getElementById(`step${currentStep}`).classList.remove('hidden');
        }
      }

      // Expose for inline handlers
      window.nextStep = nextStep; window.prevStep = prevStep; window.getLocation = getLocation; window.submitForm = submitForm; window.checkPictureAndNextStep = checkPictureAndNextStep;
    </script>
  </body>
</html>
