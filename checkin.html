var SPREADSHEET_ID = '11hXJWlWcs_rBzhbos0nxs4vyNsZ6KSUInatqpWRdcgk';
var DRIVE_FOLDER_ID = '16FNwokfBcFsOfsHRn3wAutw2GzjRx75S';
var SHEET_NAME_MEMBER = 'MEMBER';

// ฟังก์ชันสำหรับสร้าง keyId ที่ไม่ซ้ำกัน
function generateKeyId() {
  return 'ID' + Math.random().toString(36).substring(2, 6).toUpperCase();
}

// ฟังก์ชันสำหรับสร้าง URL ของไฟล์จากข้อมูล base64 และคืนค่า URL ของไฟล์
function generateFileUrl(data, folderId) {
  var imageName = `${data.name}_${Utilities.formatDate(new Date(), 'GMT+7', 'dd-MM-yyyy_HH:mm:ss')}.png`;
  var decodedImage = Utilities.base64Decode(data.base64);
  var blob = Utilities.newBlob(decodedImage, 'image/png', imageName);
  var folder = DriveApp.getFolderById(folderId);
  var file = folder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

  return `https://lh5.googleusercontent.com/d/${file.getId()}`;
}

// ฟังก์ชันสำหรับเพิ่มข้อมูลสมาชิกลงในชีตที่ระบุ
function handleMemberDataInsertion(data) {
  var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME_MEMBER);

  // ตรวจสอบว่ามีชีตที่ระบุอยู่แล้วหรือไม่ ถ้าไม่มีจะสร้างชีตใหม่
  if (!sheet) {
    sheet = SpreadsheetApp.openById(SPREADSHEET_ID).insertSheet(SHEET_NAME_MEMBER);
    sheet.appendRow(['keyId', 'userlineId', 'nameId', 'keynumberId', 'keynumber2Id', 'fileLink', 'timestamp']);
  }

  // ดึงข้อมูลทั้งหมดจากชีต
  var rows = sheet.getDataRange().getValues();
  var userlineIdExists = false;
  var existingRowIndex = -1;

  // ตรวจสอบว่ามี userlineId ซ้ำหรือไม่
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][1] === data.userlineId) {
      userlineIdExists = true;
      existingRowIndex = i + 1;
      break;
    }
  }

  // หาก userlineId มีอยู่แล้ว ทำการอัปเดตข้อมูล
  if (userlineIdExists) {
    var fileLink = generateFileUrl(data, DRIVE_FOLDER_ID);
    var timestamp = Utilities.formatDate(new Date(), 'GMT+7', 'dd-MM-yyyy HH:mm:ss');

    // อัปเดตข้อมูลในแถวที่พบ userlineId ซ้ำ
    sheet.getRange(existingRowIndex, 3, 1, 5).setValues([[data.nameId, `'${data.keynumberId}`, `'${data.keynumber2Id}`, fileLink, timestamp]]);
  
  } else {
    // หากไม่มี userlineId ซ้ำ ให้เพิ่มข้อมูลในแถวถัดไปของชีต
    var nextRow = sheet.getLastRow() + 1;
    var keyId = nextRow - 1; // สร้าง keyId โดยการนับจากเลขแถว
    var fileLink = generateFileUrl(data, DRIVE_FOLDER_ID);
    var timestamp = Utilities.formatDate(new Date(), 'GMT+7', 'dd-MM-yyyy HH:mm:ss');

    // บันทึกข้อมูลในแถวถัดไปของชีต
    sheet.getRange(nextRow, 1, 1, 7).setValues([[keyId, data.userlineId, data.nameId, `'${data.keynumberId}`, `'${data.keynumber2Id}`, fileLink, timestamp]]);
  }
}


// ฟังก์ชันสำหรับจัดการคำขอแบบ GET
function doGet(e) {
  if (e.parameter.action === 'fetchDataByName' && e.parameter.nameId) {
    return fetchDataResponseByName(e.parameter.nameId);
  }
  return fetchDataResponse();
}

// ฟังก์ชันสำหรับจัดการคำขอแบบ POST
function doPost(e) {
  try {
    // ตรวจสอบว่ามี payload แบบ JSON และจัดการ
    if (e.postData && e.postData.contents) {
      try {
        var obj = JSON.parse(e.postData.contents);

        if (obj.action === "fetchData") {
          return fetchDataResponse();
        }
        if (obj.hasOwnProperty('nameId')) {
          handleMemberDataInsertion(obj);
          return ContentService.createTextOutput("Data saved successfully").setMimeType(ContentService.MimeType.TEXT);
        }
      } catch (jsonError) {
        // หากการแปลง JSON ล้มเหลว จะทำการบันทึกข้อผิดพลาดและตรวจสอบพารามิเตอร์ URL ต่อไป
        console.log('JSON parsing error:', jsonError);
      }
    }

    // หากไม่สามารถแปลง JSON ได้ ให้ใช้การจัดการพารามิเตอร์ URL แทน
    var method = e.parameter.method;

    if (method === 'insertData') {
      var data = {
        userlineId: e.parameter.userlineId,
        nameId: e.parameter.nameId,
        keynumberId: e.parameter.keynumberId,
        keynumber2Id: e.parameter.keynumber2Id,
        base64: e.parameter.base64
      };

    } else if (method === 'updateData') {
      return doUpdate(e.parameter);

    } else if (method === 'deleteData') {
      return doDelete(e.parameter);

    } else {
      return ContentService.createTextOutput('Invalid request').setMimeType(ContentService.MimeType.TEXT);
    }
  } catch (error) {
    console.error('Error in doPost:', error);
    return ContentService.createTextOutput(`Error: ${error.message}`).setMimeType(ContentService.MimeType.TEXT);
  }
}

// ฟังก์ชันสำหรับตอบกลับข้อมูลทั้งหมดในชีต
function fetchDataResponse() {
  var data = fetchDataFromSheet();
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

// ฟังก์ชันสำหรับดึงข้อมูลทั้งหมดจากชีต
function fetchDataFromSheet() {
  var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME_MEMBER);
  return sheet.getDataRange().getValues();
}

// ฟังก์ชันสำหรับตอบกลับข้อมูลจากชื่อ
function fetchDataResponseByName(nameId) {
  var data = fetchDataFromSheetByName(nameId);
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

// ฟังก์ชันสำหรับดึงข้อมูลจากชีตตามชื่อที่ระบุ
function fetchDataFromSheetByName(nameId) {
  var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME_MEMBER);
  var rows = sheet.getDataRange().getValues();
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][2] === nameId) {
      return {
        keyid: rows[i][0],
        userlineId: rows[i][1],
        nameId: rows[i][2],
        keynumberId: rows[i][3],
        keynumber2Id: rows[i][4],
        fileLink: rows[i][5],
        point: rows[i][6],
        timestamp: rows[i][7]

      };
    }
  }
  return {};
}

// ฟังก์ชันสำหรับอัปเดตข้อมูลในชีต
function doUpdate(data) {
  var id = data.id;
  var userID = data.userID;
  var name = data.name;
  var employeeID = data.employeeID;
  var department = data.department;
  var base64Image = data.imageUrl; // รูปภาพใหม่ (Base64) หรือ URL ที่มีอยู่เดิม

  var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME_MEMBER);
  var rows = sheet.getDataRange().getValues();

  var imageUrl = data.imageUrl; // ใช้ URL เดิมเป็นค่าเริ่มต้น

  // หากมีการส่งข้อมูล Base64 มาทำการอัปโหลดภาพใหม่
  if (base64Image && base64Image.startsWith('/9j/')) { // ตรวจสอบว่าเป็น Base64
    var imageName = `${name}_${Utilities.formatDate(new Date(), 'GMT+7', 'dd-MM-yyyy_HH:mm:ss')}.png`;
    var decodedImage = Utilities.base64Decode(base64Image);
    var blob = Utilities.newBlob(decodedImage, 'image/png', imageName);
    var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    imageUrl = `https://lh5.googleusercontent.com/d/${file.getId()}`;
  }

  // อัปเดตข้อมูลในชีตตาม ID ที่ระบุ
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] == id) {
      sheet.getRange(i + 1, 2).setValue(userID);
      sheet.getRange(i + 1, 3).setValue(name);
      sheet.getRange(i + 1, 4).setValue(employeeID);
      sheet.getRange(i + 1, 5).setValue(department);
      sheet.getRange(i + 1, 6).setValue(imageUrl); // อัปเดต URL รูปภาพ
      break;
    }
  }

  return ContentService.createTextOutput("Data updated").setMimeType(ContentService.MimeType.TEXT);
}

// ฟังก์ชันสำหรับลบข้อมูลจากชีต
function doDelete(data) {
  var id = data.id;

  var sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME_MEMBER);
  var rows = sheet.getDataRange().getValues();

  // ลบข้อมูลในชีตตาม ID ที่ระบุ
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] == id) {
      sheet.deleteRow(i + 1);
      break;
    }
  }

  return ContentService.createTextOutput("Data deleted").setMimeType(ContentService.MimeType.TEXT);
}
