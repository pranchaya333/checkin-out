<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ประวัติการบันทึก</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <style>
    #loading {
      display: none;
      text-align: center;
    }

    .balloon {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      background-color: red;
      color: white;
      font-weight: bold;
      font-size: 1rem;
    }
  </style>
</head>

<body class="bg-slate-100 max-w-md mx-auto h-screen">
  <div class="container p-4">
    <div class="bg-white rounded-lg shadow-md p-6">
      <input type="hidden" id="userId" name="userId">
      <input type="hidden" id="displayName" name="displayName">

      <div id="main-info" class="mb-4">
        <div class="mb-2">
          <strong>ชื่อ:</strong> <span id="name-info" class="font-medium text-md"></span>
        </div>
        <div>
          <strong>รหัสพนักงาน:</strong> <span id="employee-id-info" class="font-medium text-md"></span>
        </div>
      </div>

      <div class="mb-4">
        <div class="font-bold">งานค้างของคุณคงเหลือ: <span id="pending-tasks" class="balloon"></span></div>
        <div>
          <strong class="block">รายละเอียดงาน:</strong>
          <pre id="task-details" class="whitespace-pre-wrap"></pre>
        </div>
      </div>

      <div class="flex justify-end">
        <button type="button" id="closeBtn" class="bg-slate-800 text-center px-4 py-2 rounded-lg text-white hover:bg-slate-600">ปิดหน้าต่างนี้</button>
      </div>

      <div id="loading" class="text-center text-slate-800 mt-4">กำลังโหลด...</div>
    </div>
  </div>

  <script>
    // แก้ไข URL ของ Web App ให้ตรงกับ URL ของ Apps Script ใหม่
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbywer1odEu4WzTny-JsG08XDWJ-6NbEpXSPBcbjWOjg-_yc3k18UTwrrbXvhwhdO4wA/exec'; 
    const LIFF_ID = '2006738214-3Dw0qlol'; 

    window.onload = function () {
      initializeLiff();
    };

    async function initializeLiff() {
      await liff.init({liffId: `${LIFF_ID}`});
      if (liff.isLoggedIn()) {
        getUserProfile();
      } else {
        liff.login();
      }
    }

    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;
        document.getElementById('displayName').value = profile.displayName;
        fetchData(profile.userId);
      } catch (error) {
        console.error('Error getting profile data:', error);
      }
    }

    async function fetchData(userId) {
      document.getElementById('loading').style.display = 'block';
      try {
        const response = await fetch(`${WEB_APP_URL}`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        console.log('Fetched data:', data);
        const filteredData = data.filter(row => row[3] === userId); // กรองข้อมูลด้วยรหัสพนักงาน (คอลัมน์ที่ 3)

        if (filteredData.length > 0) {
          const lastRow = filteredData[filteredData.length - 1];
          document.getElementById('name-info').textContent = lastRow[2];
          document.getElementById('employee-id-info').textContent = lastRow[3];
          document.getElementById('pending-tasks').textContent = lastRow[16] || '0';
          document.getElementById('task-details').textContent = lastRow[17] || '0';
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    document.getElementById('closeBtn').addEventListener('click', () => {
      liff.closeWindow();
    });
  </script>
</body>

</html>
