<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ข้อมูลส่วนตัวพนักงาน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

  <style>
    #loadingOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.26);
      border-radius: 15px;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-container {
      position: relative;
    }

    @keyframes blink {
      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .blink {
      animation: blink 1s infinite;
    }

    .container {
      /* จัดข้อความชิดซ้าย */
      text-align: left;
    }

    .profile-item {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }

    .profile-item:nth-child(odd) {
      background-color: #f2f2f2;
      /* สีพื้นหลัง 1 */
    }

    .profile-item:nth-child(even) {
      background-color: #e0e0e0;
      /* สีพื้นหลัง 2 */
    }
  </style>
</head>

<body class="bg-slate-100 h-screen">
  <div class="max-w-md mx-auto p-4 mt-4 container">
    <input type="hidden" id="displayName" name="displayName" value="J'ame •">
    <div class="loading-container">
      <div id="loadingOverlay">
        <div class="text-center text-white">กำลังโหลดข้อมูล...</div>
      </div>
      <div class="flex justify-center items-center">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6">
          <div class="flex items-center mb-4">
            <img class="mx-auto w-24 h-24 object-cover rounded-lg mr-4" id="columnEData" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png">
            <div>
              <input type="text" class="input-field bg-slate-50 text-white text-md font-bold bg-opacity-0" id="columnBData" placeholder="ชื่อ"
                name="columnBData" readonly>
              <input type="text" class="input-field text-white text-md bg-white bg-opacity-0" id="columnCData" placeholder="รหัสพนักงาน"
                name="columnCData" readonly>
              <input type="text" class="input-field text-white text-md bg-white bg-opacity-0" id="columnDData" placeholder="ตำแหน่ง"
                name="columnDData" readonly>
            </div>
          </div>

          <input type="hidden" id="userId" name="userId">
          <input type="hidden" id="columnAData" name="columnAData">
        </div>
      </div>
    </div>

    <div class="max-w-md mx-auto py-4">
      <div id="profileData">
        </div>
    </div>

    <div class="mt-4">
      <button type="button" id="closeBtn" class="bg-red-500 text-center w-full text-white py-2 px-4 rounded-lg hover:bg-red-600">ปิดหน้าต่างนี้</button>
    </div>
  </div>

  <script>
    const WEB_MEMBER_APP_URL = 'https://script.google.com/macros/s/AKfycby4ToaeyXMyeyWO50ETEghugXczRwVHYcH54MZCDJPGozz54kCgvb0Pc39AP2jf5flBHg/exec';
    const LIFF_ID = '2006738214-pKWXnb5b'; // Liff ID

    window.onload = async function () {
      await initializeLiff();
    };

    async function initializeLiff() {
      try {
        await liff.init({ liffId: `${LIFF_ID}` });
        if (liff.isLoggedIn()) {
          getUserProfile();
        } else {
          liff.login();
        }
      } catch (error) {
        console.error('Error initializing LIFF:', error);
      }
    }

    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        const userId = profile.userId;
        document.getElementById('userId').value = userId;
        document.getElementById('displayName').value = profile.displayName;
        await fetchData(userId);
      } catch (error) {
        console.error('Error getting profile data:', error);
      }
    }

    async function fetchData(userId) {
      showLoading(true);
      try {
        const response = await fetch(`${WEB_MEMBER_APP_URL}`, {
          method: 'POST',
          body: JSON.stringify({ action: 'fetchData', userId: userId })
        });
        const data = await response.json();
        data.sort((a, b) => new Date(b[6]) - new Date(a[6]));
        const row = data.find(row => row[1] === userId);
        if (row) {
          displayData(row);
        } else {
          console.log('No data found for userId:', userId);
        }
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        showLoading(false);
      }
    }

    function displayData(row) {
      document.getElementById('columnAData').value = row[1] || '';
      document.getElementById('columnBData').value = row[2] || '';
      document.getElementById('columnCData').value = row[3] || '';
      document.getElementById('columnDData').value = row[4] || '';
      document.getElementById('columnEData').src = row[5] || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png';
      document.getElementById('columnGData').value = row[10] || '';

      // แสดงข้อมูลพนักงาน
      const profileDataDiv = document.getElementById('profileData');
      profileDataDiv.innerHTML = `
              <div class="profile-item">
                <h3>${row[2]}</h3> 
              </div>
              <div class="profile-item">
                <p>วันเกิด: ${row[11]}</p> 
                <p>อายุ: ${row[12]}</p> 
              </div>
              <div class="profile-item">
                <p>วันเริ่มงาน: ${row[13]}</p> 
              </div>
              <div class="profile-item">
                <p>อายุงาน: ${row[14]}</p> 
              </div>
            `;
    }

    function showLoading(isLoading) {
      const overlay = document.getElementById('loadingOverlay');
      const inputs = document.querySelectorAll('.input-field');
      if (isLoading) {
        overlay.style.display = 'flex';
        inputs.forEach(input => input.disabled = true);
      } else {
        overlay.style.display = 'none';
        inputs.forEach(input => input.disabled = false);
      }
    }

    // ฟังก์ชันสำหรับปิดหน้าต่าง LIFF
    function closeWindow() {
      liff.closeWindow();
    }

    // เพิ่ม Event Listener ให้กับปุ่ม "closeBtn"
    document.getElementById('closeBtn').addEventListener('click', closeWindow);
  </script>
</body>

</html>
