<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰à¹„à¸‚ ---
        const LIFF_ID = "2007688681-VmqQx7q5"; // â—ï¸ðŸ‘‰ à¸§à¸²à¸‡ LIFF ID à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸—à¸µà¹ˆà¸™à¸µà¹ˆ (à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzlR8X1oc2h2yWXq_NtBXgAx2AyNQSiTlRV6pmCI1iZHR6RkI2JMwziKsgXwVUQeN3C9w/exec"; // â—ï¸ðŸ‘‰ à¸§à¸²à¸‡ URL à¸‚à¸­à¸‡ Google Apps Script à¸—à¸µà¹ˆà¸„à¸±à¸”à¸¥à¸­à¸à¸¡à¸² (à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡)
        const IMGBB_API_KEY = "57b74925b9f92d0d788aa173f66557f2"; // â—ï¸ðŸ‘‰ à¸§à¸²à¸‡ API Key à¸—à¸µà¹ˆà¹€à¸žà¸´à¹ˆà¸‡à¹„à¸”à¹‰à¸ˆà¸²à¸ imgbb à¸—à¸µà¹ˆà¸™à¸µà¹ˆ

        document.addEventListener("DOMContentLoaded", function() {
            // à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ LIFF
            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        liff.getProfile().then(profile => {
                            document.getElementById("lineUserId").value = profile.userId;
                        });
                    }
                })
                .catch(err => console.error(err));
        });

        // --- à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥à¸‚à¸­à¸‡à¸«à¸™à¹‰à¸² ---
        const agreementSection = document.getElementById("agreement-section");
        const formSection = document.getElementById("form-section");
        const acceptButton = document.getElementById("accept-button");

        acceptButton.addEventListener("click", () => {
            agreementSection.classList.add("hidden");
            formSection.classList.remove("hidden");
        });

        // --- à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸Ÿà¸­à¸£à¹Œà¸¡ ---
        const registrationForm = document.getElementById("registration-form");
        const loadingOverlay = document.getElementById("loading-overlay");
        const successOverlay = document.getElementById("success-overlay");

        registrationForm.addEventListener("submit", async function(event) {
            event.preventDefault();
            loadingOverlay.classList.remove("hidden");

            const imageFile = document.getElementById("imageUpload").files[0];
            
            try {
                // 1. à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸žà¹„à¸› imgbb
                const imageUrl = await uploadImageToImgbb(imageFile);
                if (!imageUrl) throw new Error("Image upload failed");

                // 2. à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡
                const formData = {
                    lineUserId: document.getElementById("lineUserId").value,
                    fullName: document.getElementById("fullName").value,
                    phoneNumber: document.getElementById("phoneNumber").value,
                    installationDate: document.getElementById("installationDate").value,
                    imageUrl: imageUrl
                };
                
                // 3. à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸› Google Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                // 4. à¸ªà¹ˆà¸‡ Flex Message à¸¢à¸·à¸™à¸¢à¸±à¸™
                await sendConfirmationMessage(formData.fullName, formData.phoneNumber);
                
                // 5. à¹à¸ªà¸”à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸§à¹ˆà¸²à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
                loadingOverlay.classList.add("hidden");
                successOverlay.classList.remove("hidden");

            } catch (error) {
                loadingOverlay.classList.add("hidden");
                console.error("Error:", error);
                alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥: " + error.message);
            }
        });
        
        // --- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸ªà¸£à¸´à¸¡ (à¹à¸à¹‰à¸•à¸£à¸‡à¸™à¸µà¹‰!) ---
        async function uploadImageToImgbb(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            // URL à¸‚à¸­à¸‡ imgbb à¸ˆà¸°à¸¡à¸µ API Key à¸•à¹ˆà¸­à¸—à¹‰à¸²à¸¢
            const uploadUrl = `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`;

            try {
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    return result.data.url; // à¸„à¸·à¸™à¸„à¹ˆà¸² URL à¸‚à¸­à¸‡à¸£à¸¹à¸›à¸ à¸²à¸ž
                } else {
                    console.error('imgbb API error:', result.error.message);
                    return null;
                }
            } catch (error) {
                console.error('Error uploading to imgbb:', error);
                return null;
            }
        }

        async function sendConfirmationMessage(name, phone) {
            if (liff.isInClient()) {
                const flexMessage = {
                    type: 'flex',
                    altText: 'à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸£à¸±à¸šà¸›à¸£à¸°à¸à¸±à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ',
                    contents: {
                      type: 'bubble',
                      body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                          { type: 'text', text: 'âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', weight: 'bold', size: 'xl', color: '#1DB446', align: 'center' },
                          { type: 'separator', margin: 'lg' },
                          {
                            type: 'box',
                            layout: 'vertical',
                            margin: 'lg',
                            spacing: 'sm',
                            contents: [
                              {
                                type: 'box',
                                layout: 'baseline',
                                spacing: 'sm',
                                contents: [
                                  { type: 'text', text: 'à¸Šà¸·à¹ˆà¸­', color: '#aaaaaa', size: 'sm', flex: 1 },
                                  { type: 'text', text: name, wrap: true, color: '#666666', size: 'sm', flex: 3 }
                                ]
                              },
                              {
                                type: 'box',
                                layout: 'baseline',
                                spacing: 'sm',
                                contents: [
                                  { type: 'text', text: 'à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£', color: '#aaaaaa', size: 'sm', flex: 1 },
                                  { type: 'text', text: phone, wrap: true, color: '#666666', size: 'sm', flex: 3 }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    }
                  };
                await liff.sendMessages([flexMessage]);
            }
        }

        document.getElementById("close-button").addEventListener("click", () => {
            liff.closeWindow();
        });
    </script>
